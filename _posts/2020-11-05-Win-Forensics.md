---
title: "Windows Forensic Notes, Cheatsheet"
date: "2020-11-05"
layout: single
tags:
- DFIR
categories:
- Notes
---

Hi, good to see you again.

Let's jump to DFIR thingy where this note may help us in approaching suspected/infected Windows machine in DFIR manner. Here we go.

# Common things to check

 1. Search for Known Malware
 2. Review Installed Programs
 3. Examine Prefetch
 4. Inspect Executables
 5. Review Auto-start
 6. Review Scheduled Jobs
 7. Review User Accounts
 8. Examine File System
 9. Examine Registry
 10. Restore Points
 11. Keyword Searching

# Grabbing artifacts

Grabbing artifacts is the first and important stage when it come to digital forensic. I usually will use this three tools.

1. gkape
2. Triage IR
3. Redline Comprehensive

## gkape

Kroll Artifact Parser and Extractor (KAPE) is primarily a triage program that will target a device or storage location, find the most forensically relevant artifacts (based on your needs), and parse them within a few minutes. Because of its speed, KAPE allows investigators to find and prioritize the more critical systems to their case. Additionally, KAPE can be used to collect the most critical artifacts prior to the start of the imaging process. While the imaging completes, the data generated by KAPE can be reviewed for leads, building timelines, etc.

gkape is simple GUI for the KAPE that can help you quickly enumerate all the target and module options. You can choose variety of artifacts options meet your own disire. What you want, and what you not wanted to.

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-13-19-39.png)

## Triage IR

Triage IR is a Scripted collection of system information valuable to a Forensic Analyst. Instead of copying everything, collecting some key files can solve this issue.

IRTriage will collect:

- system information
- network information
- registry hives
- disk information, and
- dump memory.

One of the powerful capabilities of IRTriage is collecting information from "Volume Shadow Copy" which can defeat many anti-forensics techniques.

The IRTriage is itself just an autoit script that depend on other tools such as:

- Win32 and 64dd
- Sysinternals Suite
- The Sleuth Kit
- Regripper
- NirSoft => MFTDump and WinPrefetchView
- md5deep and sha1deep
- CSVFileView
- 7zip
- and some windows built-in commands.

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-13-25-36.png)

Just click `Select All` and hit `Run` then the tool will do his job.

## Redline comprehensive

A Redline Collector package contains an executable script to collect data from a potentially compromised endpoint. 

There are three types of Redline Collectors: 
- Standard Collector,
- Comprehensive Collector, 
- and IOC Search Collector (Windows only).

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-13-29-05.png)

- `Standard Collector` = The Standard Collector configures scripts to gather the minimum amount of data to complete an analysis.
- `Comprehensive Collector` = The Comprehensive Collector configures scripts to gather most of the data that Redline collects and analyzes. Use this type of Redline Collector if you intend to do a full analysis or if you have only one opportunity to collect data from a computer.

For me, just choose the `Comprehensive Collector` as it give us full analysis and juicy info rather than using the `Standard` one.

How to create and run `Comprehensive Collector`?
1. Choose `Create a Comprehensive Collector`
2. Choose `Windows`
3. Check the box `Acquire Memory Image` to dump the memory image.
4. Choose the location of the `Comprehensive Collector` script and files to be save.
5. Copy the folder of the `Comprehensive Collector` to removable media.
6. On the evidence Windows machine you want to audit, run the `RunRedlineAudit.bat` script, preferably from removable media (e.g. a USB Hard Drive).

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-13-37-40.png)

## Manual grab?

You guys can refer this wonderful and completed cheatsheet by Jai Minton, https://www.jaiminton.com/cheatsheet/DFIR/#

Also, below I attached the common artifacts' locations:

### Windows Event logs

| Artifact name/path | Description |
| --- | --- |
| `%system root%\System32\winevt\logs\ *`| Windows logs |

### Registry file and few other artifact

| Artifact name/path | Description |
| --- | --- |
| `C:\Windows\System32\config\*` | All registry files (Contain a lot of artifact) |

### File execution activities

| Artifact name/path | Description |
| --- | --- |
| `NTUSER.DAT` | UserAssist, Last-Visited MRU, RunMRU Start->Run |
| `SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache` | Windows Application Compatibility Database |
| `C:\%USERPROFILE%\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations ` |  Jump Lists |
|  `C:\Windows\Prefetch` |  Prefetch |
|  `C:\Windows\AppCompat\Programs\Amcache.hve` and `C:\Windows\AppCompat\Programs\RecentFilecache.bcf` |  Amacache.hve or RecentFileCache.bcf |


### File Download activities

| Artifact name/path | Description |
| --- | --- |
| `NTUSER.DAT` | Dig into user activities like all of the mounted disks including USB thumb drives and many more |
| `%USERPROFILE%\AppData\Local\Microsoft\Outlook` | E-mail Attachments |
| `C:\%USERPROFILE%\AppData\Roaming\Skype\<skype-name>` | Skype History |
| `%USERPROFILE%\AppData\Local\Google\Chrome\UserData\Default\History` | Chrome Artifacts |
| `%userprofile%\AppData\Roaming\Mozilla\ Firefox\Profiles\<random text>.default\places.sqlite Table:moz_annos` | Firefox Artifacts |
| `%USERPROFILE%\AppData\Local\Microsoft\Windows\WebCache\WebCacheV*.dat` | IE artifacts |
| `%userprofile%\AppData\Roaming\Mozilla\ Firefox\Profiles\<random text>.default\downloads.sqlite` | Firefox downloads |
| `%USERPROFILE%\AppData\Local\Microsoft\Windows\WebCache\ WebCacheV*.dat` | IE Downloads |



### File/Folder Opening

| Artifact name/path | Description |
| --- | --- |
| `NTUSER.DAT`  | Open/Save MRU, Last-Visited MRU , Recent Files, Office Recent Files |
|  `USRCLASS.DAT` |  Shell Bags |
|`C:\%USERPROFILE%\AppData\Roaming\Microsoft\Windows\Recent\ ` or `C:\%USERPROFILE%\Recent` |  Shortcut (LNK) Files |
| `C:\%USERPROFILE%\AppData\Roaming\Microsoft\Windows\Recent\AutomaticDestinations ` |  Jump Lists |
|  `C:\Windows\Prefetch` |  Prefetch |

### Deleted File or File Knowledge

| Artifact name/path | Description |
| --- | --- |
| `NTUSER.DAT`  | XP Search – ACMRU, Search – WordWheelQuery, Last-Visited MRU,  |
| `C:\%USERPROFILE%\AppData\Local\Microsoft\Windows\Explorer` | Thumbscache |
| `C:\RECYCLER` | XP Recycle Bin |
| `C:\$Recycle.bin`  |  Win7/8/10 Recycle Bin |


### Other browser artifacts

| Artifact name/path | Description |
| --- | --- |
| Registry files | Timezone, Network History, |
|`%USERPROFILE%\AppData\Local\Microsof\Windows\INetCookies `| Cookies IE |
| `%USERPROFILE%\AppData\Roaming\Mozilla\Firefox\Profiles\<randomtext>.default\cookies.sqlite `| Cookies Firefox |
| `%USERPROFILE%\AppData\Local\Google\Chrome\UserData\Default\Local Storage `| Cookies Chrome |
| `%USERPROFILE%\AppData\Local\Microsoft\Windows\WebCache\WebCacheV*.dat `| IE Browser Search Terms |
| `%userprofile%\AppData\Roaming\Mozilla\Firefox\Profiles\<randomtext>.default\places.sqlite `|  Firefox Browser Search Terms|


### External device / USB device

| Artifact name/path | Description |
| --- | --- |
| `C:\Windows\inf\setupapi.dev.log` and `C:\Windows\setupapi.log` | First/Last Times of devices connected |
| Registry files | Key Identification,  First/Last Times, User, Volume Serial Number, Drive Letter & Volume Name |
|`C:\%USERPROFILE%\AppData\Roaming\Microsoft\Windows\Recent\ ` or `C:\%USERPROFILE%\Recent` |  Shortcut (LNK) Files |
| `System.evtx` | PnP Events | 

### Account usage

| Artifact name/path | Description |
| --- | --- |
| SAM in Registry files | Last login |
| SAM in Registry files | Last password change |
| Security event | Success/Fail Logons |
| Security event | RDP Usage |

### Browser Usage

| Artifact name/path | Description |
| --- | --- |
|`%USERPROFILE%\AppData\Local\Microsoft\Windows\WebCache\WebCacheV*.dat` | IE History |
|`%USERPROFILE%\AppData\Roaming\Mozilla\Firefox\Profiles\<random text>.default\places.sqlite` | Firefox History |
|`%USERPROFILE%\AppData\Local\Google\Chrome\User Data\Default\History` | Chrome History  |
|`%USERPROFILE%\AppData\Local\Packages\microsoft.microsoftedge_<APPID>\AC\MicrosoftEdge\Cache `| IE Cache |
| `%USERPROFILE%\AppData\Local\Mozilla\Firefox\Profiles\<randomtext>.default\Cache`| Firefox Cache |
| `%USERPROFILE%\AppData\Local\Google\Chrome\User Data\Default\Cache\ - data_# and f_######` | Chrome Cache |
| `%USERPROFILE%/AppData/Local/Microsoft/Internet Explorer/Recovery` | IE Session Restore |
| `%USERPROFILE%\AppData\Roaming\Mozilla\Firefox\Profiles\<randomtext>.default\sessionstore.js` | Firefox Session Restore |
| `%USERPROFILE%\AppData\Local\Google\Chrome\User Data\Default\` | Chrome Session Restore |


### Others

 1. Memory dump
 2. MFT

# Live Analysis

 During live analysis (weather perform the investigation on the physical machine, or you pull out vm image), we can consider these tools to perform the investigation. 

### Identify Users Logged into

- `Psloggedon` command
- `quser` command
- `netusers` command

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-15-29-41.png)

### Look for suspicious process

- Processhacker software
- Process Explorer Software
- `tasklist -V` command
- `pslist` from SysInternal

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-15-34-53.png)

### Check for suspicious network connection

- TCPview from SysInternal
- `netstat -bano` command
- `ipconfig /displaydns` command
- `arp -a` command

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-15-32-29.png)

### Persistence mechanism check

- Autorun by SysInternal

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-15-37-06.png)

### Play around with Nirsoft subtools

- Browsing history
- AlternateStreamView
- USBDeview
- FullEventLogView
- ShellBagsView
- WinPreftechView
- WinLogOnView
- LastActivityView
- OpenedFilesView
- JumpListsView
- RecentFles View
- ExecuteProgramsList
- UserProfilesView

![](https://raw.githubusercontent.com/fareedfauzi/fareedfauzi.github.io/master/assets/images/dfirnote/2020-11-05-15-40-22.png)

### Others

- Use VoidTools Everything search (to search something)
- Use FTKImager
- If find deleted file, try to recover using:
    - FTK
    - Photorec
- Registry analysis
    - Regripper
    - Grab `\%systemroot%\system32\config\*` files

# Examine Artifacts

After grabbing all the artifacts, let's examine the evidence thoroughly.

1. Memory artifact
    - Redline
    - Volatility

2. Check event logs
    - Logon Tracer for Security.evtx
    - Powershell
    - RDP
    - Use Redline

3. Timeline
    - Use Redline Comprehensive
    - or Use TimeSketch
    - or Use Plaso

4. File Download
    - Open/Sae MRU
    - Email Attachments
    - Browser Artifacts
    - Downloads

5. Program Execution
    - Jumplists (recent execute)
        - Use Jumlist Explorer
    -  Check Prefetch ( Applications that have been run on a system )
    -   Amacache.hve

6. Folder or File opening
    - Open/Save MRU
    - Last-Visited MRU
    - Recent Files `Users\username\AppData\Roaming\Microsoft\Windows\Recent`
    - Shell Bags
        - `NTUSER.dat` - ShellBag information for the Desktop,/Windows network folders, remote machines and remote folders
        - `UsrClass.dat` - ShellBag information for the Desktop, ZIP files, remote folders, local folders, Windows special folders and virtual folders.
        - Shellbag explorer
    - Recent LNKs
    - Jump Lists
    - Prefetch

7. Deleted file
    - Check Recycle Bin of every user ( `C:\$Recycle.Bin` or `C:\Recycler` )

8. Check `netstat` result

9. Check Web Browsing History
    -  Redline Comprehensive result
    -  Autopsy

10. Enumerate `Users/<name>/*` files like Desktop, Downloads etc.

11. MFT analysis
    -   [analyzeMFT.py](http://analyzeMFT.py)

12. Registry analysis
    - `NTUSER.dat`
    - Amcache
    - SYSTEM, USERS. SOFTWARE etc in `\%systemroot%\system32\config`
    - AccessData Registry Viewer tool
    - RegRipper

13. Persistence mechanism check
    - Registry
    - WMI
    - Startup folder
    - Schedule task `schtasks /Query`

# Did not found any executable malware?

1.  Malware can be hide using Alternate Data Streams technique.
2.  Set as hidden
3.  Check prefetch, jumplists, recent lnk, recent files
4.  If deleted, recover it if you have the VM image
5.  Maybe it's a fileless malware. Check powershell log if the attacker using fileless powershell.
6.  If you did not find any executable, maybe the attacker using other file format as their delivery method. Consider below files:
    -   Microsoft office files
    -   LNK shortcut
    -   .vbs or .vbe or vb
    -   .scr
    -   .PS1 .PS1XML, .PS2, .PS2XML, .PSC1, .PSC2
    -   .bat
    -   .sct
    -   .hta .html .htm
    -   js or jse and .jar
    -   pdf
    -   sfx
    -   dll
    -   tmp
    -   py
    -   inf
    -   scf
    -   .CMD

# Found malware?

- Check the owner and permission of the file
- When it last execute
- Provide a malware analysis on the malware
